<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-imports.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-entry.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-behavior.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-range-behavior.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-button-behavior.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-buttons.html"/>
<link rel="import" href="../px-datetime-field/px-datetime-field.html"/>
<link rel="import" href="../px-datetime-common/validate.html"/>
<!-- <script src="../moment/moment.js"></script> -->

<!--
Px datetime component that displays and validates a date time range.

##### Usage

    <px-datetime-range-field range="{{...}}">
    </px-datetime-range-field>

@demo demo.html
-->
<dom-module id="px-datetime-range-field">
  <link rel="import" type="css" href="css/px-datetime-range-field.css"/>
  <template>
    <div class="form flex flex--middle flex--wrap">
      <div id="fromFields" class="flex flex--middle">
        <span class=a11y>from</span>
        <px-datetime-field
          id="fromDate"
          moment-obj="{{fromMoment}}"
          date-format="[[dateFormat]]"
          time-format="[[timeFormat]]"
          show-time-zone="[[showTimeZone]]"
          hide-time="[[hideTime]]"
          hide-date="[[hideDate]]"
          is-valid="{{_fromValid}}">
        </px-datetime-field>
      </div>
      <span class="caps u-mh-">to</span>
      <div id="toFields" class="flex flex--middle u-mr+">
        <px-datetime-field
          id="toDate"
          moment-obj="{{toMoment}}"
          date-format="[[dateFormat]]"
          time-format="[[timeFormat]]"
          show-time-zone="[[showTimeZone]]"
          hide-time="[[hideTime]]"
          hide-date="[[hideDate]]"
          is-valid="{{_toValid}}">
        </px-datetime-field>
      </div>

      <template is="dom-if" if="{{showButtons}}">
        <px-datetime-buttons
          id="dtBtns"
          is-submit-button-valid="{{isValid}}">
        </px-datetime-buttons>
      </template>
    </div>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-datetime-range-field',

    behaviors: [
      pxDatetimeRangeBehavior,
      pxDatetimeButtonBehavior,
      validate
    ],

    properties: {
      /**
       * Moment format string for the DATE format to display/validate this field against
       * (see http://momentjs.com/docs/#/parsing/string-format/)
       *
       */
      dateFormat: {
          type: String,
          value: 'YYYY-MM-DD'
      },
      /**
       * Moment format string for the TIME format to display/validate this field against
       * (see http://momentjs.com/docs/#/parsing/string-format/)
       *
       */
      timeFormat: {
          type: String,
          value: 'HH:mm:ss A'
      },
      /**
       *
       * Can be set to show the timezone. Can have 2 values:
       *  'dropdown': shows the time zone as a dropdown which the user can use to
       * select a different time zone. Only contains a subset of all timezones
       *  'extendedDropdown': shows the time zone as a dropdown which the user can use to
       * select a different time zone. Contains all existing timezones (588)
       *  'text': shows the time zone as text, non editable
       *  'abbreviatedText': shows the time zone as an abbreviated text, non editable (such as PST, EST...)
       */
      showTimeZone: {
        type: String,
        value: ''
      },
      /**
       * Controls whether time is displayed in this field
       */
      hideTime: {
        type: Boolean,
        value: false
      },
      /**
       * Controls whether date should be hidden in this field. Typically used
       * in combination with hideTime to make the field showing only the time
       */
      hideDate: {
        type: Boolean,
        value: false
      },
      /**
       * If showing only the date whether the date is valid, if showing only the
       * time whetehr the time is valid, if showing both whether both are valids
       *
       */
      isValid: {
        type: Boolean,
        computed: '_getIsValid(_fromValid, _toValid, fromMoment, toMoment)'
      },
      /**
       *
       */
      _fromValid: {
        type: Boolean,
        value: true
      },
      /**
       *
       */
      _toValid: {
        type: Boolean,
        value: true
      }
    },

    observers: [
      // '_validateRangeAndBroadcastChanges(fromMoment, toMoment, isValid)'
    ],

    /**
     * Sets up listeners for a variety of events fired from or passing through this component
     *
     */
    ready: function() {
      // listens for a button click, enter key, or esp key
      this.listen(this, 'px-datetime-button-clicked', '_dateTimeButtons');
      //listens for a change in the moment obj to visual indication if the entry has changed
      // TODO set a dev set attrb to enable or disable visual indication if changed
      // TODO set a dev set attrb to enable or disable visual indication if submitted && move it from hard coded in validate to an event like this
      this.listen(this, 'px-moment-changed', '_addChangedClass');
    },
    /**
     * Called in validate
     *
     * Turns validation classes on and off for 'fromFields' and 'toFields'
     *
     * @param {Boolean} isError
     */
    _toggleErrorClasses: function(isError) {
      this.toggleClass('validation-error', isError, this.$$('#fromFields'));
      this.toggleClass('validation-error', isError, this.$$('#toFields'));
    },
    /**
     * Called in px-datetime-entry by '_handleFocus'
     *
     * Remove visuallyhidden class from dtBtns.
     *
     * Determine which field was changed and add validation-changed class to the changed field
     *
     * If autoSubmit is true and the entry is valid, call datetime-button-clicked
     *
     * @param {Event} evt: The data packet is a moment object
     */
    _addChangedClass: function(evt) {
      // TODO: enable the moment change, but not applied
      this.toggleClass('visuallyhidden', false, this.$$('#dtBtns'));

      if(evt.detail.moment===this.toMoment){
        this.toggleClass('validation-changed', true, this.$$('#toFields'));
        this.toggleClass('is-focused', true, this.$$('#toFields'));
      } else {
        this.toggleClass('validation-changed', true, this.$$('#fromFields'));
        this.toggleClass('is-focused', true, this.$$('#fromFields'));
      }

      if(this.autoSubmit){
        setTimeout(function(){
          if(this.isSubmitButtonValid){
            this.fire('datetime-button-clicked',{action : true});
          }
        }.bind(this),10);
      }
      evt.stopPropagation();
    },
    /**
     * Called by '_dateTimeButtons' event.
     *
     * Remove validation-changed class from both fields
     *
     * If datetimeButtonsDisplayOption is 'onfocus', hide the buttons
     */
    _removeChangedClass: function() {
      this.toggleClass('validation-changed', false, this.$$('#toFields'));
      this.toggleClass('validation-changed', false, this.$$('#fromFields'));
      if(this.datetimeButtonsDisplayOption === 'onfocus'){
        this.toggleClass('visuallyhidden', true, this.$$('#dtBtns'));
      }
    },
    /**
     * Called by '_dateTimeButtons' event after the range is set.
     *
     * Add 'validation-success' class to both fields.
     *
     * If datetimeButtonsDisplayOption is 'onfocus', hide the buttons
     */
    _toggleSuccessClasses: function() {
      this.toggleClass('validation-success', true, this.$$('#fromFields'));
      this.toggleClass('validation-success', true, this.$$('#toFields'));

      setTimeout(function(){
        this.toggleClass('validation-success', false, this.$$('#fromFields'));
        this.toggleClass('validation-success', false, this.$$('#toFields'));
      }.bind(this),800);
    },
    /**
     * Event handler.
     * Trigged when cancel, submit, esc, or enter are clicked
     *
     * Calls _removeChangedClass
     *
     * If action is true, set 'range' to 'toMoment' and 'fromMoment'.
     * Calls _toggleSuccessClasses
     *
     * If action is false, reset the fields to last submitted dates.
     *
     * @param {Event} e event object
     */
    _dateTimeButtons:function(e){
      var normalizedEvent = Polymer.dom(e);

      this._removeChangedClass();

      if(normalizedEvent.event.detail.action){
        this.set('range', {
          from: this.fromMoment.toISOString(),
          to: this.toMoment.toISOString()
        });
        this._toggleSuccessClasses();
      } else {
        this._setRange();
      }
      e.stopPropagation();
    },
    /**
     *
     */
    _getIsValid: function(_fromValid, _toValid, fromMoment, toMoment) {
      if (!this._validateRangeOrder()) {
        var em = Polymer.dom(this.$.toDate.root).querySelectorAll("px-datetime-entry:last-of-type")[0];
        if(em.isValid === true){
          em.isValid = false;
          em.validationErrorMessage = "Range is reversed";
        }
        return false;
      }
      else {
        var em = Polymer.dom(this.$.toDate.root).querySelectorAll("px-datetime-entry:last-of-type")[0];
        if(em){
          em.isValid = true;
          console.log("ran");
        }
        return _fromValid === true && _toValid === true;
      }
    },
    /**
     * Validation for the range. Makes sure the ranges are in chronological order
     *
     * @return {Boolean} passed range validation
     */
    _applyValidationStyle: function() {
      // if the from date is before the to date, everything is ok
      if(this.fromMoment.isBefore(this.toMoment)) {
        this._toggleErrorClasses(false);
        this._submitButtonState(this.allFieldsValid);
        return true;
      } else {
        // toggle validation errors
        this._toggleErrorClasses(true);
        this._submitButtonState(false);
        return false;
      }
    }

  });
</script>
